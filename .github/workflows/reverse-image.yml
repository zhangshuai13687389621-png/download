name: Reverse Engineer Docker Image

on:
  workflow_dispatch: # 支持手动触发工作流

jobs:
  analyze-and-extract:
    runs-on: ubuntu-latest
    permissions:
      contents: write # 允许 Action 提交代码到仓库

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Free up runner disk space
        run: |
          echo "Disk space before cleanup:"
          df -h
          
          # 删除大体积的预装工具以释放 30GB+ 的磁盘空间
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
          
          echo "Disk space after cleanup:"
          df -h

      - name: Pull target Docker image
        run: |
          docker pull ccr.ccs.tencentyun.com/cube-studio/notebook:jupyter-ubuntu-bigdata

      - name: Inspect Operating System
        run: |
          # 运行一个临时容器来打印内部的操作系统版本信息
          docker run --rm ccr.ccs.tencentyun.com/cube-studio/notebook:jupyter-ubuntu-bigdata cat /etc/os-release
          
      - name: Generate and Extract files
        run: |
          # 定义镜像名称和整理后的输出目录名
          IMAGE="ccr.ccs.tencentyun.com/cube-studio/notebook:jupyter-ubuntu-bigdata"
          TARGET_DIR="notebook-jupyter-ubuntu-bigdata"
          
          # 创建统一存放它的父文件夹
          mkdir -p "$TARGET_DIR"
          
          # 1. 运行 laniksj/dfimage 逆向生成 Dockerfile，并重定向到目标目录中
          docker run -v /var/run/docker.sock:/var/run/docker.sock --rm laniksj/dfimage "$IMAGE" > "$TARGET_DIR/Dockerfile.generated"

          # 2. 创建临时容器
          docker create --name temp_container "$IMAGE"
          
          # 3. 在目标目录下创立 extracted_files 的对应目录树
          EXTRACT_PATH="$TARGET_DIR/extracted_files"
          mkdir -p "$EXTRACT_PATH/opt/third/maven/conf"
          mkdir -p "$EXTRACT_PATH/opt/third/hadoop/etc"
          mkdir -p "$EXTRACT_PATH/opt/third/hive/conf"
          mkdir -p "$EXTRACT_PATH/opt/third/flink"
          mkdir -p "$EXTRACT_PATH/examples"
          
          # 4. 从容器提取所有指出的配置文件到这里
          docker cp temp_container:/init.sh "$EXTRACT_PATH/"
          docker cp temp_container:/opt/third/maven/conf/settings.xml "$EXTRACT_PATH/opt/third/maven/conf/"
          docker cp temp_container:/opt/third/hadoop/etc/hadoop "$EXTRACT_PATH/opt/third/hadoop/etc/"
          
          docker cp temp_container:/opt/third/hive/conf/. "$EXTRACT_PATH/opt/third/hive/conf/" 2>/dev/null || true
          docker cp temp_container:/opt/third/flink/flink-conf.yaml "$EXTRACT_PATH/opt/third/flink/" 2>/dev/null || true
          docker cp temp_container:/examples/. "$EXTRACT_PATH/examples/" 2>/dev/null || true
          
          # 清理临时容器
          docker rm temp_container

      - name: Auto Commit changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Auto-extract Dockerfile and config files to notebook-jupyter-ubuntu-bigdata format"
          file_pattern: "notebook-jupyter-ubuntu-bigdata/**"
